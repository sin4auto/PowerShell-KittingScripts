# Windows 11 に Hyper‑V をインストールして仮想マシンを構築する手順（推敲版 v4）

本書は **ISO からの通常インストール（手順3A/4A）** と、**クイック作成での Windows 11 開発者版（手順3B/4B）** の 2 通りを併記します。  
読み手の状況に合うルートを選んでください。

---

## 手順0：Windows 11 ISO ファイルの入手

仮想マシンにインストールするため、Windows 11 のディスクイメージ（ISO）を Microsoft 公式サイトから取得します。

1. https://www.microsoft.com/ja-jp/software-download/windows11 にアクセス  
2. 「**x64 デバイス用 Windows 11 ディスク イメージ（ISO）をダウンロードする**」までスクロール  
3. 「**Windows 11（x64 デバイス用のマルチエディション ISO）**」を選び「**今すぐダウンロード**」をクリック  
4. 表示言語に「**日本語**」を選び「**確認**」  
5. 「**64 ビット ダウンロード**」をクリック  
6. 保存先とファイル名（例：`Win11_24H2_Japanese_x64.iso`）を確認して保存

> **メモ**：ダウンロードリンクの有効期間は **24 時間** です。仮想マシン作成時にこの ISO を指定します。

---

## 手順1：Hyper‑V の有効化（インストール）

Hyper‑V は Windows 機能として標準搭載されています。

1. **コントロール パネル**を開く  
2. **プログラムと機能** → 左の **Windows の機能の有効化または無効化**  
3. 一覧から **Hyper‑V** にチェック → **OK**  
4. 指示に従い **再起動**

---

## 手順2：仮想ネットワークの準備（仮想スイッチの作成）

1. 再起動後、**Hyper‑V マネージャー**を起動  
2. 右ペインの **仮想スイッチ マネージャー** をクリック  
3. **新しい仮想ネットワーク スイッチ** → **外部** を選択  
4. **仮想スイッチの作成** をクリック  
5. 名前（例：有線ネットワーク / 無線ネットワーク）を設定  
6. 外部ネットワークに使用中の NIC（例：Realtek PCIe GbE / Intel Ethernet 等）を選択  
7. **OK** をクリックして保存

> **推奨**：Wi‑Fi は不安定になりやすいため、可能なら **有線 LAN** を使用してください。

---

## 手順3A：仮想マシンの作成（通常・ISO から）

1. **新規 > 仮想マシン**  
2. **名前**（例：キッティングテスト機）を設定  
3. **世代**：**第 2 世代**  
4. **メモリ**：**動的メモリを使用する** にチェック  
   - スタートアップ RAM：**4096 MB（4 GB）**  
   - 最大 RAM：**8192 MB（8 GB）**  
5. **ネットワーク**：手順 2 で作成したスイッチを選択  
6. **仮想ハードディスク**：既定値（**127 GB 推奨**）  
7. **インストール オプション**：  
   - 「**ブート イメージ ファイルからオペレーティング システムをインストールする**」を選択  
   - 手順 0 の **ISO** を指定  
8. **完了**

---

## 手順3B：仮想マシンの作成（**クイック作成**・Windows 11 **開発者版**）

> 開発者向け評価 VM は **クイック作成**から数クリックで用意できます。

1. **Hyper‑V マネージャー**右側の **クイック作成** をクリック  
2. ギャラリーから **Windows 11 開発者用環境（Windows 11 Developer Environment）** を選択  
   - 表示されない場合：ギャラリー更新、管理者で起動し直し、一時的な表示言語の英語化 等で改善することがあります  
3. **作成** をクリック（必要に応じて **名前** と **仮想スイッチ** を指定）  
4. 完了後に **接続 → 起動**  
5. 以降は **手順 4B** を参照（OOBE・サインイン・日本語化）

---

## 手順4A：Windows 11 のインストールと初期設定（ISO から手動）

1. 対象 VM を右クリック → **接続**  
2. ウィンドウで **起動**  
3. 「**Press any key to boot from CD or DVD...**」が出たら任意キー  
4. セットアップの指示に従って進める  
5. **キーボード**は「**Japanese Keyboard (106/109 key)**」を選択

**よくあるトラブル**  
- **プロダクト キー入力を求められる**：**プロダクト キーがありません** を選択してスキップ  
- **この PC は現在 Windows 11 のシステム要件を満たしていません**：VM の **設定 > セキュリティ** で  
  - **セキュア ブートを有効にする**  
  - **トラステッド プラットフォーム モジュール（TPM）を有効にする**  
  → 再起動してやり直す  
- **PIN 入力画面が出ない（拡張セッション不可）**：  
  1) まず **基本セッション**で接続してサインイン  
  2) **設定 > アカウント > サインイン オプション** の「Windows Hello サインインのみを許可」を **オフ**  
  3) サインアウト/再起動後に拡張セッションが利用可能  
- **キーボード配列の不一致（@ で [ が入力される等）**：  
  **設定 > 時刻と言語 > 言語と地域 > 日本語（言語のオプション）** → **キーボードのレイアウトを変更** → **日本語キーボード (106/109)** → 再起動

---

## 手順4B-1：初期設定（クイック作成・**開発者版**）

> クイック作成の VM は Windows 11 が展開済み（英語 UI が多い）です。以下を確認してください。

1. **接続 → 起動** して OOBE を完了  
   - ネットワーク接続の確認（必要なら仮想スイッチを見直し）  
   - Microsoft アカウント / ローカル アカウントでサインイン  
2. **Windows Update** を実行（品質更新と Microsoft Store アプリの更新）  
3. **拡張セッションを使う場合**：**設定 > アカウント > サインイン オプション** の  
   「Windows Hello サインインのみを許可」を **オフ**  
4. 以降の **日本語化** は下記「4B‑2」を実施

### 4B‑2：日本語化（GUI）

1. **設定 > 時刻と言語 > 言語と地域**  
2. **言語を追加** → 「**日本語**」 → **言語パックをインストール**（必要なら 音声/手書き/OCR/TTS）  
3. **Windows の表示言語** を **日本語** に変更 → **サインアウト → サインイン**  
4. **IME**：日本語の **… > 言語のオプション > キーボード** で **Microsoft IME** を確認  
5. **設定 > 時刻と言語 > 言語と地域 > キーボード > レイアウトを変更する > 日本語キーボード(106/109 キー) > 再起動**
6. **非 Unicode アプリ（文字化け対策）**：  
   **コントロール パネル > 地域 > 管理 > システム ロケールの変更** → **日本語（日本）**  
7. **ようこそ画面 / 新規ユーザーへ反映（任意）**：  
   **地域 > 管理 > 設定のコピー** → 2 箇所にチェック  
8. **タイムゾーン**：**設定 > 日付と時刻** → **(UTC+09:00) 大阪, 札幌, 東京**

---

## 手順5：チェックポイントの作成

初期状態を保存しておくと、何度でも同じ状態に戻せます。

1. セットアップ完了後、VM を **シャットダウン**  
2. Hyper‑V マネージャーで対象 VM を右クリック → **チェックポイント**  
3. 作成された項目の名前を「**初期設定完了_クリーン状態**」などに変更

---

## 手順6：テスト サイクルの実行

チェックポイントを活用して検証を効率化します。

1. チェックポイントから VM を起動  
2. アプリのインストールや設定変更を実施  
3. 問題があればチェックポイントを **適用** して復元  
4. 必要なテストを繰り返す

---

## 付録：スクリプト実行時のエラー対策（実行ポリシー / エンコーディング）

### A. 実行ポリシーでブロックされる（UnauthorizedAccess / running scripts is disabled）
```powershell
# 管理者 PowerShell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
Unblock-File .\ja-JP-autolocale.ps1
```
**グループポリシーで固定されているか確認**
```powershell
Get-ExecutionPolicy -List | Format-Table -AutoSize
```
`MachinePolicy` / `UserPolicy` が設定されていればローカル変更は効きません。管理側に例外（例：RemoteSigned）を相談。

**ポリシーを変えずに 1 行で実行**
```powershell
powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\ja-JP-autolocale.ps1 -Preset Full -KeepEnUSKeyboard
```

### B. 「The string is missing the terminator: '」等の構文エラー（文字化け）
**原因**：ファイルのエンコーディング不整合（UTF‑8 以外 / スマートクォート混入 等）  
**対処：UTF‑8 (BOM 付き) に保存し直す**
```powershell
$path = 'C:\ja-JP-autolocale.ps1'
(Get-Content $path -Raw) | Set-Content $path -Encoding UTF8  # PowerShell 5.1 は BOM 付き
```
**スマートクォート混入チェック**
```powershell
Select-String -Path C:\ja-JP-autolocale.ps1 -Pattern "[‘’“”]" -AllMatches
```
ヒットしたら `'` と `"` の ASCII に置換。

### C. PowerShell 7（pwsh）で実行（エンコ回避に有効）
```powershell
pwsh -NoProfile -ExecutionPolicy Bypass -File C:\ja-JP-autolocale.ps1 -Preset Full -KeepEnUSKeyboard
```
PowerShell 7 は既定で UTF‑8 を前提とするため、文字化け起因のパースエラーを回避しやすいです。

---

## まとめ

- Hyper‑V により、Windows 11 の仮想環境を **安定** かつ **柔軟** に構築できます。  
- ISO ルート（3A/4A）とクイック作成ルート（3B/4B）を用意し、**日本語化（GUI/自動）** とその周辺の **実行エラー対策** まで網羅しました。  
- **チェックポイント** を使えば、反復作業や検証を **高速かつ安全** に行えます。
